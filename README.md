# OTP Service

## Описание

Данное приложение реализует сервис аутентификации с поддержкой регистрации пользователей, генерацией и валидацией OTP-кодов, а также разграничением ролей (админ и обычный пользователь). Для работы используется PostgreSQL 17 и взаимодействие с БД через JDBC. Аутентификация реализована с использованием JWT.

---

## Запуск сервиса

1. Убедитесь, что у вас установлен PostgreSQL 17, создана база данных, и настроены таблицы согласно ТЗ.
2. Укажите параметры подключения к базе в `DataSourceProvider.java`.
3. Постройте проект с помощью Maven или Gradle.
4. Запустите класс `your.package.api.HttpServerApp`, который поднимает HTTP-сервер на порту 8080.

---

## Как пользоваться сервисом

### Регистрация пользователя

- **URL:** `POST /register`
- **Тело запроса (JSON):**

{
"username": "user1",
"password": "secretpass",
"role": "USER", // либо "ADMIN"
"email": "user1@example.com",
"phone": "+1234567890",
"telegramId": "123456789"
}

- Регистрация второго администратора невозможна, если админ уже существует.

### Вход в систему (логин)

- **URL:** `POST /login`
- **Тело запроса (JSON):**

{
"username": "user1",
"password": "secretpass"
}

- В ответе возвращается JWT токен для авторизации.

---

## Административный API (требует JWT токен с ролью ADMIN)

### Получить конфигурацию OTP

- **URL:** `GET /admin/otp-config`
- В заголовке запроса укажите `Authorization: Bearer <jwt-token>`

### Изменить конфигурацию OTP

- **URL:** `PUT /admin/otp-config`
- **Тело запроса (JSON):**

{
"codeLength": 6,
"expirationTimeSeconds": 300
}


### Получить список всех пользователей (кроме администраторов)

- **URL:** `GET /admin/users`
- Требуется заголовок авторизации.

### Удалить пользователя и связанные OTP

- **URL:** `DELETE /admin/users/{id}`
- `{id}` — идентификатор пользователя.
- Требуется заголовок авторизации.

---

## API пользователя

### Генерация OTP-кода

- **URL:** `POST /otp/generate`
- **Тело запроса (JSON):**

{
"operationId": "op123",
"channel": "SMS" // варианты: SMS, EMAIL, TELEGRAM, FILE
}

- Требуется JWT-токен обычного пользователя в заголовке Authorization.

### Валидация OTP-кода

- **URL:** `POST /otp/validate`
- **Тело запроса (JSON):**

{
"otpCode": "123456"
}

- Требуется JWT-токен пользователя.

---

## Тестирование

- Используйте curl или Postman для отправки HTTP запросов.
- Для регистрации администратора и пользователя сделайте POST на `/register`.
- Залогиньтесь через `/login`, получите токен.
- Для вызова защищенных методов указывайте в заголовке:  
`Authorization: Bearer <ваш JWT токен>`
- При генерации OTP смотрите консоль сервера, где будут эмулироваться SMS, Email и Telegram, либо смотрите файл `otp_codes.txt` для сохраненных кодов.
- Проверьте валидацию через `/otp/validate`.
- Администратор может редактировать конфигурацию OTP и управлять пользователями с помощью соответствующих API.
